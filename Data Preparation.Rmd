---
title: "Data Preparation"
author: "Rangga"
date: "2022-08-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Library we used
```{r}
library(tidyverse)
library(readxl)
library(plotly)
library(lubridate)
library(tidyr)
library(extrafont)
library(glue)
library(scales)
library(zoo)
```

# Read Data
Since the Data are separated between country, we will read them one by one first
```{r}
afghanistan <- read_excel("datainput/afghanstrike.xlsx")
pakistan <- read_excel("datainput/pakistanstrike.xlsx")
somalia <- read_excel("datainput/somaliastrike.xlsx")
yemen <- read_excel("datainput/yemenstrike.xlsx")
```
Check their structure
```{r}
glimpse(afghanistan)
```

```{r}
glimpse(pakistan)
```

```{r}
glimpse(somalia)
```

```{r}
glimpse(yemen)
```

After checking, there are columns that have same information between the 4 datasets:

* `Date`
* `Province`
* `US Confirmed`
* `Minimum Strikes`
* `Maximum Strikes` 
* `Minimum Total Killed `
* `Maximum Total Killed`
* `Minimum Civilians Killed`
* `Maximum Civilians Killed`
* `Minimum Children Killed`
* `Maximum Children Killed`
* `Minimum Injured`
* `Maximum Injured`

However, Pakistan and Somalia still don't have any general location for their strikes. Based on the smaller location, we will detect and create new `Province` column for them. Also we will synchronize all columns name & value between each dataset for easier integration later.

```{r}
#Afghanistan
afghanistan <- 
  afghanistan %>% 
  rename(`US Confirmed`="US confirmed?",
         `Minimum Strikes` = "Minimum strikes",
         `Maximum Strikes` = "Maximum strikes",
         `Minimum Total Killed` = "Minimum total people killed",
         `Maximum Total Killed` = "Maximum total people killed",
         `Minimum Civilians Killed` = "Minimum civilians reported killed",
         `Maximum Civilians Killed` = "Maximum civilians reported killed",
         `Minimum Children Killed` = "Minimum children reported killed",
         `Maximum Children Killed` = "Maximum children reported killed",
         `Minimum Injured` = "Minimum reported injured",
         `Maximum Injured` = "Maximum reported injured") %>% 
  mutate(Country = "Afghanistan",
         `US Confirmed` = as.character(`US Confirmed`)) %>%
  select(Date, Country, Province,`US Confirmed`,`Minimum Strikes`,`Maximum Strikes`,`Minimum Total Killed`,
         `Maximum Total Killed`,`Minimum Civilians Killed`,`Maximum Civilians Killed`,`Minimum Children Killed`,
         `Maximum Children Killed`,`Minimum Injured`,`Maximum Injured`)

#Change the Confirmed Value to 1 = Confirmed, 0 = Possible
afghanistan <- 
  afghanistan %>%
  mutate(`US Confirmed` = ifelse(grepl("1", afghanistan$`US Confirmed`) == TRUE, "Confirmed","Possible"))
```

```{r}
#Pakistan
pakistan <- 
  pakistan %>% 
  mutate(Province = ifelse(grepl("South Waziristan|North Waziristan|Bajaur Agency|Bannu Frontier Region|Kurram Agency|Orakzai Agency|Khyber Agency|North/South Waziristan|Khyber Pakhtunkhwa province|Balochistan", pakistan$Area) == TRUE, "Khyber Pakhtunkhwa",NA),
         Minimum_strikes = 0,
         Maximum_strikes = 1,
         Country = "Pakistan",
         `US Confirmed` = 0) %>% 
  rename(`Minimum Strikes` = "Minimum_strikes",
         `Maximum Strikes` = "Maximum_strikes",
         `Minimum Total Killed` = "Minimum total people killed",
         `Maximum Total Killed` = "Maximum total people killed",
         `Minimum Civilians Killed` = "Minimum civilians reported killed",
         `Maximum Civilians Killed` = "Maximum civilians reported killed",
         `Minimum Children Killed` = "Minimum children reported killed",
         `Maximum Children Killed` = "Maximum children reported killed",
         `Minimum Injured` = "Minimum reported injured",
         `Maximum Injured` = "Maximum reported injured") %>%
  mutate(`US Confirmed` = as.character(`US Confirmed`)) %>%
  select(Date, Country, Province,`US Confirmed`,`Minimum Strikes`,`Maximum Strikes`,`Minimum Total Killed`,
         `Maximum Total Killed`,`Minimum Civilians Killed`,`Maximum Civilians Killed`,`Minimum Children Killed`,
         `Maximum Children Killed`,`Minimum Injured`,`Maximum Injured`)

#Change the Confirmed Value to 1 = Confirmed, 0 = Possible
pakistan <- 
  pakistan %>%
  mutate(`US Confirmed` = ifelse(grepl("1", pakistan$`US Confirmed`) == TRUE, "Confirmed","Possible"))
```

For Somalia, since the Location Data are still overspread, we will mutate them separately
```{r}
somalia <- 
  somalia %>% 
  mutate(Province = ifelse(grepl("Banadiir|Mogadishu|Wadajir", somalia$Location) == TRUE, "Banadiir",
          ifelse(grepl("Dusa Marreb|South-central Somalia|Southern Somalia|Near Gobanale|Gaduug|Gaduud|Awhiigle", somalia$Location) == TRUE, "Galguduud",
                  ifelse(grepl("Yasooman|Raso Camp|Hiran", somalia$Location) == TRUE, "Hiiraan",
                         ifelse(grepl("Middle Shabelle", somalia$Location) == TRUE, "Shabeellaha Dhexe",
                                ifelse(grepl("Barawe|Afgoye|Elasha Biyaha|Lower Shabelle|Guhm|Hawai|Dugule|Balad Amin|Kunyo-Barow|Kuntuwarey|Awdhegle|Dar es Salam village|Kunyo Barrow|Tortoroow|Bariire|Basra village|Idow Jalad|Mubarak|Gandarshe|Beled Amin|Kunyow Barrow|Awdeegle|Janaale|lower Shabelle|Baledogle|Qunyo Barrow|Bacaw", somalia$Location) == TRUE, "Shabeellaha Hoose",
                                       ifelse(grepl("Bargal|Qandala town|Puntland|Bosasso|Bari", somalia$Location) == TRUE, "Bari",
                                              ifelse(grepl("Galcayo|Haradere|El Burr|Debatscile|Mudug", somalia$Location) == TRUE, "Mudug",
                                                     ifelse(grepl("Dinsoor|Bay region", somalia$Location) == TRUE, "Bay",
                                                            ifelse(grepl("Baardheere", somalia$Location) == TRUE, "Gedo",
                                                                   ifelse(grepl("Jillib|Sakow|Jilib|Jamecco|Lebede|Basra|Middle Juba|Saakow|Dujuuma|Caliyoow Barrow", somalia$Location) == TRUE, "Jubbada Dhexe",
                                                                          ifelse(grepl("Ras Kamboni|Hayo|Waldena|Dhobley|Kismayo|Juba|Lower Juba|Caba|Luglaw|Jamaame|Kamsuuma|Lower Juba|Jubaland|Kobon|Bangeeni|Jamaame|Beer Xaani", somalia$Location) == TRUE, "Jubbada Hoose",
                                                                                 ifelse(grepl("Golis Mountains", somalia$Location) == TRUE, "Togdheer",NA)))))))))))))
  
```
Then we follow the exact same steps:
```{r}
#Somalia
somalia <- 
  somalia %>% 
  rename(`US Confirmed`="Confirmed/\r\npossible US strike",
         `Minimum Strikes` = "Minimum strikes",
         `Maximum Strikes` = "Maximum strikes",
         `Minimum Total Killed` = "Minimum people killed",
         `Maximum Total Killed` = "Maximum people killed",
         `Minimum Civilians Killed` = "Minimum civilians killed",
         `Maximum Civilians Killed` = "Maximum civilians killed",
         `Minimum Children Killed` = "Minimum children killed",
         `Maximum Children Killed` = "Maximum children killed",
         `Minimum Injured` = "Minimum people injured",
         `Maximum Injured` = "Maximum people injured") %>% 
  mutate(Country = "Somalia") %>% 
  select(Date, Country, Province,`US Confirmed`,`Minimum Strikes`,`Maximum Strikes`,`Minimum Total Killed`,
         `Maximum Total Killed`,`Minimum Civilians Killed`,`Maximum Civilians Killed`,`Minimum Children Killed`,
         `Maximum Children Killed`,`Minimum Injured`,`Maximum Injured`)
```

```{r}
#Yemen
yemen <- 
  yemen %>% 
  rename(`US Confirmed`="Confirmed/\r\npossible US attack?",
         `Minimum Strikes` = "Minimum number of strikes",
         `Maximum Strikes` = "Maximum number of strikes",
         `Minimum Total Killed` = "Minimum people killed",
         `Maximum Total Killed` = "Maximum people killed",
         `Minimum Civilians Killed` = "Minimum civilians reported killed",
         `Maximum Civilians Killed` = "Maximum civilians reported killed",
         `Minimum Children Killed` = "Minimum children reported killed",
         `Maximum Children Killed` = "Maximum children reported killed",
         `Minimum Injured` = "Minimum people injured",
         `Maximum Injured` = "Maximum people injured") %>% 
  mutate(Country = "Yemen") %>% 
  select(Date, Country, Province,`US Confirmed`,`Minimum Strikes`,`Maximum Strikes`,`Minimum Total Killed`,
         `Maximum Total Killed`,`Minimum Civilians Killed`,`Maximum Civilians Killed`,`Minimum Children Killed`,
         `Maximum Children Killed`,`Minimum Injured`,`Maximum Injured`)
```

Now all the datasets all have the same columns and type-values, we will concatenate them into one dataset. Moreover, since we want to extract information based on Presidency Terms too, we will add new column called `Presidency`.

```{r}
#Datasets Concatenation
drone <- rbind(afghanistan,pakistan,yemen,somalia) %>% 
  arrange(Date) %>% 
  mutate( Presidency = case_when(
  Date <= "2009-01-20" ~ "George W. Bush",
  Date <= "2017-01-20" ~ "Barack Obama",
  Date <= "2021-01-20" ~ "Donald J. Trump"))

drone
```

---------------------------------------Presidency Data for our Overview-------------------------------------------

# Bush
```{r}
bush.strikes <- 
  drone %>% 
  filter(Presidency %in% "George W. Bush") %>% 
  select(`Maximum Strikes`) %>% 
  summarise(Total = sum(`Maximum Strikes`))

bush.kill <- 
  drone %>% 
  filter(Presidency %in% "George W. Bush") %>% 
  select(`Minimum Total Killed`, `Maximum Total Killed`) %>% 
  summarise(Min = sum(`Minimum Total Killed`),
            Max = sum(`Maximum Total Killed`))

bush.civs <- 
  drone %>% 
  filter(Presidency %in% "George W. Bush") %>% 
  select(`Minimum Civilians Killed`, `Maximum Civilians Killed`) %>% 
  summarise(Min = sum(`Minimum Civilians Killed`),
            Max = sum(`Maximum Civilians Killed`))

bush.child <- 
  drone %>% 
  filter(Presidency %in% "George W. Bush") %>% 
  select(`Minimum Children Killed`, `Maximum Children Killed`) %>% 
  summarise(Min = sum(`Minimum Children Killed`),
            Max = sum(`Maximum Children Killed`))

bush.injured <- 
  drone %>% 
  filter(Presidency %in% "George W. Bush") %>% 
  select(`Minimum Injured`, `Maximum Injured`) %>% 
  summarise(Min = sum(`Minimum Injured`),
            Max = sum(`Maximum Injured`))

#Collateral Damage Rate
bush.rate <- (bush.civs$Max + bush.child$Max) / bush.kill$Max
```

# Obama
```{r}
obama.strikes <- 
  drone %>% 
  filter(Presidency %in% "Barack Obama") %>% 
  select(`Maximum Strikes`) %>% 
  summarise(Total = sum(`Maximum Strikes`))

obama.kill <- 
  drone %>% 
  filter(Presidency %in% "Barack Obama") %>% 
  select(`Minimum Total Killed`, `Maximum Total Killed`) %>% 
  summarise(Min = sum(`Minimum Total Killed`),
            Max = sum(`Maximum Total Killed`))

obama.civs <- 
  drone %>% 
  filter(Presidency %in% "Barack Obama") %>% 
  select(`Minimum Civilians Killed`, `Maximum Civilians Killed`) %>% 
  summarise(Min = sum(`Minimum Civilians Killed`),
            Max = sum(`Maximum Civilians Killed`))

obama.child <- 
  drone %>% 
  filter(Presidency %in% "Barack Obama") %>% 
  select(`Minimum Children Killed`, `Maximum Children Killed`) %>% 
  summarise(Min = sum(`Minimum Children Killed`),
            Max = sum(`Maximum Children Killed`))

obama.injured <- 
  drone %>% 
  filter(Presidency %in% "Barack Obama") %>% 
  select(`Minimum Injured`, `Maximum Injured`) %>% 
  summarise(Min = sum(`Minimum Injured`),
            Max = sum(`Maximum Injured`))

#Collateral Damage Rate
obama.rate <- (obama.civs$Max + obama.child$Max) / obama.kill$Max
```

# Trump
```{r}
trump.strikes <- 
  drone %>% 
  filter(Presidency %in% "Donald J. Trump") %>% 
  select(`Maximum Strikes`) %>% 
  summarise(Total = sum(`Maximum Strikes`))

trump.kill <- 
  drone %>% 
  filter(Presidency %in% "Donald J. Trump") %>% 
  select(`Minimum Total Killed`, `Maximum Total Killed`) %>% 
  summarise(Min = sum(`Minimum Total Killed`),
            Max = sum(`Maximum Total Killed`))

trump.civs <- 
  drone %>% 
  filter(Presidency %in% "Donald J. Trump") %>% 
  select(`Minimum Civilians Killed`, `Maximum Civilians Killed`) %>% 
  summarise(Min = sum(`Minimum Civilians Killed`),
            Max = sum(`Maximum Civilians Killed`))

trump.child <- 
  drone %>% 
  filter(Presidency %in% "Donald J. Trump") %>% 
  select(`Minimum Children Killed`, `Maximum Children Killed`) %>% 
  summarise(Min = sum(`Minimum Children Killed`),
            Max = sum(`Maximum Children Killed`))

trump.injured <- 
  drone %>% 
  filter(Presidency %in% "Donald J. Trump") %>% 
  select(`Minimum Injured`, `Maximum Injured`) %>% 
  summarise(Min = sum(`Minimum Injured`),
            Max = sum(`Maximum Injured`))

#Collateral Damage Rate
trump.rate <- (trump.civs$Max + trump.child$Max) / trump.kill$Max
```

---------------------------------------------Plot for Each Country------------------------------------------------

# Strikes by Each Country

```{r}
total.strike <- drone %>% 
  filter(Country %in% "Afghanistan") %>% 
  select(`Maximum Strikes`) %>% 
  summarize(`Strikes Reported` = sum(`Maximum Strikes`))
```

```{r}
strike.plot <- 
drone %>% 
  filter(Country %in% "Afghanistan") %>% 
  select(Date,`Maximum Strikes`) %>% 
  mutate(Date = floor_date(Date, "quarter")) %>% 
  group_by(Date) %>% 
  summarise(Strikes = sum(`Maximum Strikes`)) %>%
  mutate(Quart = case_when(
    month(Date) == "1" ~ "Q1",
    month(Date) == "4" ~ "Q2",
    month(Date) == "7" ~ "Q3",
    month(Date) == "10" ~ "Q4"
  )) %>% 
  mutate(Quart = paste(year(Date), Quart),
         Label = glue("{Quart}
                        Strikes: {comma(Strikes)}"),
         Date = as.Date(Date, format = "%d-%m-%Y")) %>%  
  ggplot(aes(Date, Strikes, text = Label)) +
  geom_line(aes(group=1),color = "#5A5981", size = 1) +
  geom_point(col = "#A6655F", size = 2, alpha = 0.5) +
  scale_x_date(breaks = "3 months", date_labels = "%b %Y") +
  labs(x = NULL,
       y = NULL) +
  theme(plot.background = element_rect(fill = "#E8E1DB", color = "#E8E1DB"),
        panel.background = element_rect(fill = "#E8E1DB"),
        panel.grid = element_line(alpha(colour = "#C3C3C3",alpha = 0.4)),
        axis.text.x = element_text(angle = 45, hjust = 5, color = "Black", face = "italic", family = "Georgia"),
        axis.text.y = element_text(face = "bold", family = "Georgia"))

ggplotly(strike.plot, tooltip = "text")
```

#Death by Each Country

```{r}
total.death <- drone %>% 
  filter(Country %in% "Afghanistan") %>% 
  select(`Maximum Total Killed`) %>% 
  summarize(`Deaths Reported` = sum(`Maximum Total Killed`))
```

```{r}
death.plot <- 
drone %>% 
  filter(Country %in% "Afghanistan") %>% 
  select(`Minimum Total Killed`, `Maximum Total Killed`, `Minimum Civilians Killed`, `Maximum Civilians Killed`, 
         `Minimum Children Killed`, `Maximum Children Killed`) %>% 
  pivot_longer(cols = c("Minimum Total Killed","Maximum Total Killed",
                        "Minimum Civilians Killed", "Maximum Civilians Killed", 
                        "Minimum Children Killed", "Maximum Children Killed"), 
               names_to = "Name", values_to = "Value") %>% 
  mutate( Type = case_when(
  Name == "Minimum Total Killed" | Name == "Maximum Total Killed" ~ "Total",
  Name == "Minimum Civilians Killed" | Name == "Maximum Civilians Killed" ~ "Civilians",
  Name == "Minimum Children Killed" | Name == "Maximum Children Killed" ~ "Children")) %>% 
  mutate ( Name = case_when(
  Name == "Minimum Total Killed" | Name == "Minimum Civilians Killed" | Name == "Minimum Children Killed" ~ "Minimum",
  Name == "Maximum Total Killed" | Name == "Maximum Civilians Killed" | Name == "Maximum Children Killed" ~ "Maximum")) %>% 
  group_by(Type, Name) %>% 
  summarize(Value = sum(Value), .groups = 'drop') %>% 
  ungroup() %>%
  mutate(label = glue("{Type}
                      Deaths: {comma(Value)}")) %>% 
  ggplot(aes(Value, Type, text = label)) +
  geom_col(aes(fill = factor(Name, levels=c("Maximum", "Minimum"))),
           position = "stack", width = 0.7) +
  scale_fill_manual(values = alpha(c("#A6655F", "#F5DB9E"),0.9)) +
  scale_x_continuous(breaks = seq(0,14000,2000)) +
  labs(x = "Deaths",
       y = NULL,
       fill = NULL) +
  theme(legend.position = "right",
        legend.direction = "vertical",
        legend.background = element_rect(fill="#E8E1DB", color = "#E8E1DB"),
        legend.key = element_rect(fill="#E8E1DB", color = "#E8E1DB"),
        legend.title = element_text(colour = "Black", face ="bold", size = 9, family = "Georgia"),
        legend.text = element_text(color="Black", face ="italic", family = "Georgia"),
        plot.background = element_rect(fill = "#E8E1DB", color = "#E8E1DB"),
        panel.background = element_rect(fill = "#E8E1DB"),
        panel.grid = element_line(alpha(colour = "#C3C3C3",alpha = 0.4)),
        axis.title.x = element_text(colour = "Black", family = "Georgia",face = "bold"),
        axis.text.x = element_text(angle = 15, color = "Black", face = "bold", family = "Georgia"),
        axis.text.y = element_text(color="Black", face="italic", family = "Georgia"))

ggplotly(death.plot, tooltip = "text")
```

#Injured

```{r}
total.injured <- drone %>% 
  filter(Country %in% "Afghanistan") %>% 
  select(`Maximum Injured`) %>% 
  summarize(`Injured Reported` = sum(`Maximum Injured`))
```

```{r}
injured.plot <- 
drone %>% 
  filter(Country %in% "Afghanistan") %>% 
  select(`Minimum Injured`, `Maximum Injured`) %>% 
  rename(Minimum = "Minimum Injured",
         Maximum = "Maximum Injured") %>% 
  pivot_longer(cols = c("Minimum", "Maximum"),
               names_to = "Injured",
               values_to = "Value") %>% 
  group_by(Injured) %>% 
  summarize(Total = sum(Value)) %>% 
  mutate(label = glue("Injured: {comma(Total)}")) %>% 
  ggplot(aes(Total, reorder(Injured, Total), text = label, fill = Injured )) +
  scale_x_continuous(breaks = seq(0,1750,250)) +
  geom_col(width = 0.6) +
  scale_fill_manual(values = alpha(c("#5A5981", "#F5DB9E"),0.9)) +
  labs(x = "Injured",
       y = NULL,
       fill = NULL) +
  theme(legend.position = "right",
        legend.direction = "vertical",
        legend.background = element_rect(fill="#E8E1DB", color = "#E8E1DB"),
        legend.key = element_rect(fill="#E8E1DB", color = "#E8E1DB"),
        legend.title = element_text(colour = "Black", face ="bold", size = 9, family = "Georgia"),
        legend.text = element_text(color="Black", face ="italic", family = "Georgia"),
        plot.background = element_rect(fill = "#E8E1DB", color = "#E8E1DB"),
        panel.background = element_rect(fill = "#E8E1DB"),
        panel.grid = element_line(alpha(colour = "#C3C3C3",alpha = 0.4)),
        axis.title.x = element_text(colour = "Black", family = "Georgia",face = "bold"),
        axis.text.x = element_text(angle = 15, color = "Black", face = "bold", family = "Georgia"),
        axis.text.y = element_text(color="Black", face="italic", family = "Georgia"))

ggplotly(injured.plot, tooltip = "text")
```

